openapi: 3.0.0
info:
  title: Instal API
  version: 1.0.0
  description: Secure API for client management with authentication and rate limiting
security:
  - bearerAuth: []
paths:
  /clients:
    post:
      summary: Create a new client
      operationId: create-client
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e607k429lt9lqo0dkj
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    get:
      summary: List all clients
      operationId: list-clients
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e2hioa9nvq86e1fhtv
        service_account_id: ajevsnimu8g62t29vlad
  /clients/search:
    get:
      summary: Search for clients
      operationId: search-clients
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e46icm3kuqf5mshnbq
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /clients/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      summary: Get a client by ID
      operationId: get-client
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e8b3od95f0h2fiernq
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    put:
      summary: Update a client
      operationId: update-client
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4egqldupji1j6a52h1v
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    delete:
      summary: Delete a client
      operationId: delete-client
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4emvjk3b8bslg8tnibd
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /investors:
    post:
      summary: Create a new investor
      operationId: create-investor
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4ej2auh8nuqd4ug07b4
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    get:
      summary: List all investors
      operationId: list-investors
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e30o3lml4ur152tei1
        service_account_id: ajevsnimu8g62t29vlad
  /investors/search:
    get:
      summary: Search for investors
      operationId: search-investors
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4edkrcgp4spbhlhoirn
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /investors/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      summary: Get an investor by ID
      operationId: get-investor
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e8b3od95f0h2fiernq
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /wallets:
    post:
      summary: Create a new wallet
      operationId: create-wallet
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: WALLET_CREATE_FUNCTION_ID
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    get:
      summary: List user's wallets with balances
      operationId: list-wallets
      parameters:
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [personal, investor]
          description: Filter wallets by type
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: WALLET_LIST_FUNCTION_ID
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /wallets/{id}/top-up:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      summary: Add funds to wallet
      operationId: wallet-top-up
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: WALLET_TOPUP_FUNCTION_ID
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /wallets/{id}/ledger:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      summary: Get wallet transaction ledger
      operationId: wallet-ledger
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Number of transactions to return
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [installment, adjustment, transfer, reversal, initial_investment, profit_distribution]
          description: Filter by transaction type
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Start date for filtering (ISO format)
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: End date for filtering (ISO format)
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4ehnha81dhv1t61vb5h
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    put:
      summary: Update an investor
      operationId: update-investor
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4ekneiud8r8kmlv5gfp
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    delete:
      summary: Delete an investor
      operationId: delete-investor
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e3j9imqjagflipespv
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /installments:
    post:
      summary: Create a new installment
      operationId: create-installment
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4ejin4kah34cvt6mbt8
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    get:
      summary: List all installments
      operationId: list-installments
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4eji2a3n3b9kmgvkcni
        service_account_id: ajevsnimu8g62t29vlad
  /installments/search:
    get:
      summary: Search for installments
      operationId: search-installments
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4edfrgpjcc1ohgj6efo
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /installments/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      summary: Get an installment by ID
      operationId: get-installment
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4etn874nnro96omhmdk
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'

    delete:
      summary: Delete an installment
      operationId: delete-installment
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e6t65nb39k5dksq7s7
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /installment-payments/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    put:
      summary: Update an installment payment
      operationId: update-installment-payment
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4ec86pvqoqla7ck2qv7
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /analytics-optimized:
    get:
      summary: Get optimized analytics data
      operationId: analytics-optimized
      security:
        - bearerAuth: []
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e8s7pip0ssrbj54dcm
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /auth/register:
    post:
      summary: Register a new user
      operationId: auth-register
      security: 
        - apiKey: []  # Auth endpoints still use API key
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e4t4mv875gkg24at8a
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /auth/login:
    post:
      summary: Login user
      operationId: auth-login
      security: 
        - apiKey: []  # Auth endpoints still use API key
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e8jcns4qe2bkvh7rvv
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /auth/refresh:
    post:
      summary: Refresh access token
      operationId: auth-refresh
      security: 
        - apiKey: []  # Auth endpoints still use API key
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4evah37mne0rubchbl8
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /auth/verify:
    post:
      summary: Verify JWT token
      operationId: auth-verify
      security: 
        - apiKey: []  # Auth endpoints still use API key
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4ebrg3ucrog7lqe4egr
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /auth/user:
    get:
      summary: Get current user information
      operationId: auth-get-user
      security:
        - bearerAuth: []
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4eni47g77jfmhonbhde
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    put:
      summary: Update user profile
      operationId: auth-update
      security:
        - bearerAuth: []
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e5tijqfm1q7ikuj0c5
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /whatsapp/settings:
    get:
      summary: Get WhatsApp reminder settings
      description: Retrieve current WhatsApp reminder settings for the authenticated user
      operationId: get-whatsapp-settings
      security:
        - bearerAuth: []
      responses:
        '200':
          description: WhatsApp settings retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WhatsAppSettings'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4eu4h1irj55no6jt4jn
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
    put:
      summary: Update WhatsApp reminder settings
      description: Update WhatsApp reminder settings including credentials and templates
      operationId: update-whatsapp-settings
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WhatsAppSettingsUpdate'
      responses:
        '200':
          description: Settings updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WhatsAppSettings'
        '400':
          description: Invalid request data
        '401':
          description: Unauthorized
        '500':
          description: Internal server error
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4efejgin025sorlklin
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /whatsapp/test-connection:
    post:
      summary: Test WhatsApp API connection
      description: Test connection to Green API with provided or stored credentials
      operationId: test-whatsapp-connection
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WhatsAppConnectionTest'
      responses:
        '200':
          description: Connection test completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WhatsAppConnectionResult'
        '400':
          description: Invalid request data
        '401':
          description: Unauthorized
        '500':
          description: Internal server error
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e9f146f73o17mdfg5k
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /whatsapp/send-manual-reminder:
    post:
      summary: Send manual WhatsApp reminders
      description: Send WhatsApp reminders to specific installments manually
      operationId: send-manual-reminder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ManualReminderRequest'
      responses:
        '200':
          description: Reminders processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManualReminderResponse'
        '400':
          description: Invalid request data
        '401':
          description: Unauthorized
        '500':
          description: Internal server error
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4ea495odfsc1cvltug4
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /subscription/validate-code:
    post:
      summary: Validate and activate subscription code
      description: Validates a subscription code and activates it for the user
      operationId: validate-subscription-code
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateCodeRequest'
      responses:
        '200':
          description: Code validated and activated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateCodeResponse'
        '400':
          description: Invalid code or request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4eut8n056onak8o4uit
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
  /subscription/status:
    post:
      summary: Check subscription status
      description: Check the current subscription status for a user
      operationId: check-subscription-status
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckStatusRequest'
      responses:
        '200':
          description: Subscription status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckStatusResponse'
        '400':
          description: Invalid request data
        '401':
          description: Unauthorized
        '500':
          description: Internal server error
      x-yc-apigateway-integration:
        type: cloud_functions
        function_id: d4e8pkgusps8fmc76klv
        service_account_id: ajevsnimu8g62t29vlad
        payload_format_version: '1.0'
components:
  securitySchemes:
    apiKey:
      type: apiKey
      in: header
      name: X-API-Key
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    WhatsAppSettings:
      type: object
      properties:
        green_api_instance_id:
          type: string
          description: Green API instance ID (masked for security)
        green_api_token:
          type: string
          description: Green API token (masked for security)
        reminder_template_7_days:
          type: string
          description: Template for 7-day reminders
        reminder_template_due_today:
          type: string
          description: Template for due today reminders
        reminder_template_manual:
          type: string
          description: Template for manual reminders
        is_enabled:
          type: boolean
          description: Whether WhatsApp reminders are enabled
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    WhatsAppSettingsUpdate:
      type: object
      properties:
        green_api_instance_id:
          type: string
          description: Green API instance ID
        green_api_token:
          type: string
          description: Green API token
        reminder_template_7_days:
          type: string
          description: Template for 7-day reminders
        reminder_template_due_today:
          type: string
          description: Template for due today reminders
        reminder_template_manual:
          type: string
          description: Template for manual reminders
        is_enabled:
          type: boolean
          description: Whether to enable WhatsApp reminders
        test_connection:
          type: boolean
          description: Whether to test connection after update
          default: false
    WhatsAppConnectionTest:
      type: object
      required:
        - green_api_instance_id
        - green_api_token
      properties:
        green_api_instance_id:
          type: string
          description: Green API instance ID to test
        green_api_token:
          type: string
          description: Green API token to test
    WhatsAppConnectionResult:
      type: object
      properties:
        success:
          type: boolean
          description: Whether connection test was successful
        message:
          type: string
          description: Result message
        error:
          type: string
          description: Error message if connection failed
        account_info:
          type: object
          description: Account information if connection successful
    ManualReminderRequest:
      type: object
      required:
        - installment_ids
      properties:
        installment_ids:
          type: array
          items:
            type: string
          description: List of installment IDs to send reminders for
          minItems: 1
          maxItems: 50
        template_type:
          type: string
          enum: [manual, 7_days, due_today]
          default: manual
          description: Type of template to use for reminders
    ManualReminderResponse:
      type: object
      properties:
        processed_count:
          type: integer
          description: Total number of installments processed
        successful_sends:
          type: integer
          description: Number of reminders sent successfully
        failed_sends:
          type: integer
          description: Number of reminders that failed to send
        results:
          type: array
          items:
            $ref: '#/components/schemas/ReminderResult'
          description: Detailed results for each installment
    ReminderResult:
      type: object
      properties:
        installment_id:
          type: string
          description: ID of the installment
        client_name:
          type: string
          description: Name of the client
        client_phone:
          type: string
          description: Client phone number (masked)
        template_type:
          type: string
          description: Template type used
        status:
          type: string
          enum: [success, failed]
          description: Status of the reminder sending
        message_id:
          type: string
          description: WhatsApp message ID if successful
        error:
          type: string
          description: Error message if failed
        attempts:
          type: integer
          description: Number of attempts made
    ValidateCodeRequest:
      type: object
      required:
        - code
        - user_id
      properties:
        code:
          type: string
          description: Subscription code to validate
          example: "SUB-2025-001-ABC123"
        user_id:
          type: string
          description: ID of the user activating the code
    ValidateCodeResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether the operation was successful
        subscription:
          $ref: '#/components/schemas/SubscriptionData'
    CheckStatusRequest:
      type: object
      required:
        - user_id
      properties:
        user_id:
          type: string
          description: ID of the user to check subscription status for
    CheckStatusResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether the operation was successful
        subscriptions:
          type: array
          items:
            $ref: '#/components/schemas/SubscriptionData'
          description: List of all subscription codes for the user
    SubscriptionData:
      type: object
      properties:
        code:
          type: string
          description: Subscription code
        subscription_type:
          type: string
          enum: [trial, basic, pro]
          description: Type of subscription
        duration:
          type: string
          enum: [monthly, yearly, 14days]
          description: Duration of the subscription
        user_telegram:
          type: string
          nullable: true
          description: User's Telegram handle
        amount:
          type: number
          format: double
          description: Subscription amount
        created_date:
          type: string
          format: date-time
          description: When the code was created
        activated_date:
          type: string
          format: date-time
          nullable: true
          description: When the code was activated
        end_date:
          type: string
          format: date-time
          nullable: true
          description: When the subscription expires
        status:
          type: string
          enum: [unused, active, expired]
          description: Current status of the subscription
        activated_by:
          type: string
          nullable: true
          description: User ID who activated the code
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              description: Error code
              example: "INVALID_CODE"
            message:
              type: string
              description: Human-readable error message
              example: "The subscription code is invalid or has already been used"
x-yc-apigateway-cors:
  origin:
    - '*'
  methods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
  headers:
    - Content-Type
    - X-API-Key
    - Authorization
  maxAge: 86400 